//
//  bleManager.h
//  bash
//
//  Created by 胡旭 on 16/3/12.
//  Copyright © 2016年 胡旭. All rights reserved.
//

#import <Foundation/Foundation.h>
#import <CoreBluetooth/CoreBluetooth.h>
#import "bleModel.h"
#import "bleDataType.h"

//*-------------------------------------------------
//名称：痛经100Hz镇痛方案A
//实施部位：小腿，三阴交足三里各一个电极
//刺激波形：100Hz，100us脉宽，正负双脉冲
//包数：10包
//持续时间：20min
//起始Irate：0x32
//-------------------------------------------------*//

//包头：
//0x10	0x00	0x1101	0x000a
//数据包：
//0x13	0x00	0x0000	0x32	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x0000
//0x13	0x00	0x0001	0x32	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x0078
//0x13	0x00	0x0002	0x32	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x00F0
//0x13	0x00	0x0003	0x32	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x0168
//0x13	0x00	0x0004	0x32	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x01E0
//0x13	0x00	0x0005	0x32	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x0258
//0x13	0x00	0x0006	0x32	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x02D0
//0x13	0x00	0x0007	0x32	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x0248
//0x13	0x00	0x0008	0x32	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x03C0
//0x13	0x00	0x0009	0x32	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x0438

static TreatData femaleTreat[10] = {
    {0x13, 0x00, htons(0x0000), 0x32, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x0000)},
    {0x13, 0x00, htons(0x0001), 0x32, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x0078)},
    {0x13, 0x00, htons(0x0002), 0x32, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x00F0)},
    {0x13, 0x00, htons(0x0003), 0x32, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x0168)},
    {0x13, 0x00, htons(0x0004), 0x32, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x01E0)},
    {0x13, 0x00, htons(0x0005), 0x32, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x0258)},
    {0x13, 0x00, htons(0x0006), 0x32, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x02D0)},
    {0x13, 0x00, htons(0x0007), 0x32, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x0248)},
    {0x13, 0x00, htons(0x0008), 0x32, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x03C0)},
    {0x13, 0x00, htons(0x0009), 0x32, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x0438)},
};

//*-------------------------------------------------
//名称：腰痛100Hz镇痛方案A
//实施部位：小腿，三阴交足三里各一个电极
//刺激波形：100Hz，100us脉宽，正负双脉冲
//包数：10包
//持续时间：20min
//起始Irate：0x32
//-------------------------------------------------*//

//包头：
//0x10	0x01	0x1001	0x000a
//数据包：
//0x13	0x01	0x0000	0x00	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x0000
//0x13	0x01	0x0001	0x00	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x0078
//0x13	0x01	0x0002	0x00	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x00F0
//0x13	0x01	0x0003	0x00	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x0168
//0x13	0x01	0x0004	0x00	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x01E0
//0x13	0x01	0x0005	0x00	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x0258
//0x13	0x01	0x0006	0x00	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x02D0
//0x13	0x01	0x0007	0x00	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x0248
//0x13	0x01	0x0008	0x00	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x03C0
//0x13	0x01	0x0009	0x00	0x0190	0x3C	0x19	0x7F	0xC8	0x1388	0x0000	0x28	0x0438

static TreatData waistTreat[10] = {
    {0x13, 0x01, htons(0x0000), 0x00, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x0000)},
    {0x13, 0x01, htons(0x0001), 0x00, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x0078)},
    {0x13, 0x01, htons(0x0002), 0x00, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x00F0)},
    {0x13, 0x01, htons(0x0003), 0x00, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x0168)},
    {0x13, 0x01, htons(0x0004), 0x00, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x01E0)},
    {0x13, 0x01, htons(0x0005), 0x00, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x0258)},
    {0x13, 0x01, htons(0x0006), 0x00, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x02D0)},
    {0x13, 0x01, htons(0x0007), 0x00, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x0248)},
    {0x13, 0x01, htons(0x0008), 0x00, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x03C0)},
    {0x13, 0x01, htons(0x0009), 0x00, htons(0x0190), 0x3c, 0x19, 0x7f, 0xc8, htons(0x1388), htons(0x0000), 0x28, htons(0x0438)},
};

@protocol bleManagerDelegate <NSObject>

- (void)updateBLEDevice:(NSArray *)deviceList;

@end


@interface bleManager : NSObject <CBCentralManagerDelegate, CBPeripheralDelegate>
@property (nonatomic, assign) id<bleManagerDelegate> delegate;
@property bleModel *connectedBLEModel;
@property CBService *bleDataService;
@property CBCharacteristic *bleDataNotifyCharacteristic;
@property CBCharacteristic *bleDataWriteCharacteristic;
@property CBCharacteristic *OTADataNotifyCha;
@property CBCharacteristic *OTADataWriteCha;


+ (instancetype)shareInstance;
- (void)initCenteralManger;
- (void)connectPeripheral:(CBPeripheral *)peripheral withModel:(bleModel *)model;
//主动读取
- (void)readValue:(CBPeripheral *)peripheral ForCharacteristic:(CBCharacteristic *)characteristic;
//订阅服务，有变化会从peripheral主动下发消息
- (void)setNotify:(CBPeripheral *)peripheral ForCharacteristic:(CBCharacteristic *)characteristic;
- (void)writeValue:(CBPeripheral *)peripheral ForCharacteristic:(CBCharacteristic *)characteristic;


- (NSMutableArray *)getDeviceList;
- (BOOL)isConnected;

- (void)writeBLEData:(NSData *)data;

- (void)startScan;
- (void)stopScan;

- (void)disconnect:(CBPeripheral *)peripheral;

- (int)convertRssiToStrength:(NSNumber *)rssi;

@end
